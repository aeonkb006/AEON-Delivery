<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="apple-touch-icon" href="icon.png"> 
    <link rel="icon" type="image/png" href="icon.png">
    <title>é€è²¨æŸ¥è©¢ç³»çµ± (æœ€çµ‚ç‰ˆ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; background-color: #f4f6f9; padding: 20px; display: flex; justify-content: center; }
        .container { background: white; padding: 0; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); width: 100%; max-width: 600px; overflow: hidden; }
        
        .header { background: #333; color: white; padding: 20px; text-align: center; }
        h2 { margin: 0 0 15px 0; font-size: 22px; }
        
        .tabs { display: flex; background: #e0e0e0; padding: 5px; border-radius: 8px; margin-top: 10px; }
        .tab-btn { flex: 1; border: none; padding: 12px; font-size: 16px; font-weight: bold; cursor: pointer; border-radius: 6px; transition: 0.3s; background: transparent; color: #555; }
        .tab-btn.active-dc { background: #007bff; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .tab-btn.active-cs { background: #fd7e14; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        .notice-section { padding: 15px 20px 0 20px; }
        .notice-box { padding: 15px; border-radius: 8px; font-size: 14px; line-height: 1.6; display: none; }
        .notice-dc { background-color: #e7f3ff; color: #0056b3; border: 1px solid #b8daff; }
        .notice-cs { background-color: #fff4e6; color: #d9480f; border: 1px solid #ffcc99; }
        .notice-title { font-weight: bold; font-size: 15px; margin-bottom: 5px; display: block; }
        .notice-content ul { margin: 0; padding-left: 20px; }
        .notice-content li { margin-bottom: 4px; }

        .search-section { padding: 20px; background: #fff; border-bottom: 1px solid #eee; }
        input[type="text"] { width: 100%; padding: 15px; font-size: 18px; border: 2px solid #ddd; border-radius: 8px; box-sizing: border-box; outline: none; transition: 0.3s; }
        input[type="text"]:focus { border-color: #007bff; box-shadow: 0 0 8px rgba(0,123,255,0.15); }
        
        .results-area { padding: 20px; min-height: 120px; background: #f9f9f9; }
        .empty-msg { text-align: center; color: #888; margin-top: 20px; font-size: 15px; }
        
        /* è¨ºæ–·é¢æ¿ */
        .status-panel { padding: 15px; background: #fff3cd; border-bottom: 1px solid #ffeeba; text-align: center; font-size: 14px; color: #856404; display: none; }
        .status-log { text-align: left; background: #333; color: #0f0; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 12px; margin-top: 10px; height: 100px; overflow-y: scroll; display: none; }
        
        .result-card { background: white; border-radius: 8px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: relative; overflow: hidden; border-left: 5px solid #ccc; }
        .result-card.type-dc { border-left-color: #007bff; }
        .type-dc .card-tag { background: #e7f3ff; color: #0056b3; }
        .result-card.type-cs { border-left-color: #fd7e14; }
        .type-cs .card-tag { background: #fff4e6; color: #d9480f; }

        .area-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .area-name { font-size: 20px; font-weight: bold; color: #333; }
        .card-tag { font-size: 12px; padding: 2px 8px; border-radius: 4px; font-weight: bold; }
        
        .info-row { display: flex; align-items: flex-start; margin-bottom: 8px; font-size: 15px; color: #444; }
        .icon { margin-right: 8px; min-width: 20px; }
        .time-slot { background: #eee; padding: 5px 10px; border-radius: 4px; font-weight: bold; display: inline-block; margin-top: 2px; }
        .alert-box { background-color: #fff5f5; border: 1px solid #ffcccc; color: #cc0000; padding: 10px; border-radius: 6px; font-size: 14px; margin-top: 10px; }
        .no-service-card { border-left-color: #dc3545 !important; opacity: 0.8; }

        .calendar-section { padding: 20px; background: #fff; border-top: 1px solid #eee; display: none; }
        .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .cal-header button { background: none; border: 1px solid #ddd; padding: 5px 15px; border-radius: 5px; cursor: pointer; font-size: 18px; color: #555; }
        .cal-title { font-weight: bold; font-size: 18px; color: #333; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; font-size: 14px; }
        .cal-day-header { font-weight: bold; color: #666; padding-bottom: 5px; border-bottom: 1px solid #eee; margin-bottom: 5px; font-size: 13px; }
        .cal-cell { padding: 5px 2px; border-radius: 5px; min-height: 45px; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; position: relative; }
        .cal-date { z-index: 2; font-weight: bold; margin-bottom: 2px; }
        .cal-holiday { font-size: 10px; color: #e74c3c; line-height: 1.1; transform: scale(0.9); white-space: nowrap; }
        .cal-cell.empty { background: none; }
        .cal-cell.highlight::before { content: ""; position: absolute; top: 2px; left: 50%; transform: translateX(-50%); width: 26px; height: 26px; background-color: #d4edda; border-radius: 50%; z-index: 1; }
        .cal-cell.highlight .cal-date { color: #155724; }
        .cal-cell.is-holiday .cal-date { color: #e74c3c !important; }
        /* é€±æœ«é¡è‰² (Sun & Sat) */
        .cal-cell:nth-child(7n), .cal-cell:nth-child(7n+1) { color: #999; }
        /* Sun (ç¬¬1æ¬„) ç‰¹åˆ¥æ”¹ç´…è‰² */
        .cal-day-header:nth-child(1) { color: #e74c3c; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2>ğŸšš é€è²¨æŸ¥è©¢é é¢</h2>
        <div class="tabs">
            <button class="tab-btn active-dc" onclick="switchTab('dc')">ğŸ“¦ DC æ´¾é€</button>
            <button class="tab-btn" onclick="switchTab('cs')">ğŸ’ğŸ»â€â™€ï¸ CS æ´¾é€</button>
        </div>
    </div>

    <div id="statusPanel" class="status-panel">
        <span id="statusText">æ­£åœ¨å˜—è©¦é€£ç·šè‡³ Google Sheet...</span>
        <div id="debugLog" class="status-log"></div>
        <div id="manualTest" style="display:none; margin-top:10px;">
            <a href="#" id="testLink" target="_blank" style="color:#007bff;">[é»æ“Šé€™è£¡æ¸¬è©¦ç›´æ¥ä¸‹è¼‰ CSV]</a>
        </div>
    </div>

    <div class="notice-section">
        <div id="notice-dc" class="notice-box notice-dc" style="display: block;">
            <span class="notice-title">ğŸ“¦ DC ä¸Šæ¨“æ”¶è²»åŠé ˆçŸ¥ï¼š</span>
            <div class="notice-content" id="content-dc">è¼‰å…¥ä¸­...</div>
        </div>
        <div id="notice-cs" class="notice-box notice-cs">
            <span class="notice-title">ğŸ’ğŸ»â€â™€ï¸ CS ä¸Šæ¨“æ”¶è²»åŠé ˆçŸ¥ï¼š</span>
            <div class="notice-content" id="content-cs">è¼‰å…¥ä¸­...</div>
        </div>
    </div>
    
    <div class="search-section">
        <div class="input-wrapper">
            <input type="text" id="searchInput" placeholder="è«‹è¼¸å…¥é€è²¨åœ°å€..." onkeyup="performSearch()">
        </div>
    </div>
    
    <div id="results" class="results-area">
        <div class="empty-msg">è«‹è¼¸å…¥åœ°å€é—œéµå­—æŸ¥è©¢</div>
    </div>

    <div class="calendar-section" id="calendarArea">
        <div class="cal-header">
            <button onclick="changeMonth(-1)">&#10094;</button>
            <div class="cal-title" id="calTitle">2026å¹´ 1æœˆ</div>
            <button onclick="changeMonth(1)">&#10095;</button>
        </div>
        <div class="cal-grid" id="calGrid">
            <div class="cal-day-header">Sun</div>
            <div class="cal-day-header">Mon</div>
            <div class="cal-day-header">Tue</div>
            <div class="cal-day-header">Wed</div>
            <div class="cal-day-header">Thu</div>
            <div class="cal-day-header">Fri</div>
            <div class="cal-day-header">Sat</div>
        </div>
    </div>
</div>

<script>
    // ä½¿ç”¨ CodeTabs Proxy
    const proxy = "https://api.codetabs.com/v1/proxy?quest=";

    const rawDC = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRVUTcCv0PJLr8oTDvXHUP-U1gQ0gutnDgyLBAJAIAilLnRTedyrwLrws6vPQ5iGIM-pu9dpx0voitj/pub?gid=0&single=true&output=csv";
    const rawCS = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRVUTcCv0PJLr8oTDvXHUP-U1gQ0gutnDgyLBAJAIAilLnRTedyrwLrws6vPQ5iGIM-pu9dpx0voitj/pub?gid=907154772&single=true&output=csv";
    const rawSetting = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRVUTcCv0PJLr8oTDvXHUP-U1gQ0gutnDgyLBAJAIAilLnRTedyrwLrws6vPQ5iGIM-pu9dpx0voitj/pub?gid=1663839235&single=true&output=csv";

    const urlDC = proxy + encodeURIComponent(rawDC);
    const urlCS = proxy + encodeURIComponent(rawCS);
    const urlSetting = proxy + encodeURIComponent(rawSetting);

    // =========================================================

    const holidays2026 = { "1-1": "å…ƒæ—¦", "2-17": "å¹´åˆä¸€", "2-18": "å¹´åˆäºŒ", "2-19": "å¹´åˆä¸‰", "4-3": "è€¶ç©Œå—é›£", "4-4": "å—é›£ç¿Œæ—¥", "4-6": "å¾©æ´»ç¯€", "5-1": "å‹å‹•ç¯€", "5-24": "ä½›èª•", "6-19": "ç«¯åˆç¯€", "7-1": "å›æ­¸", "10-1": "åœ‹æ…¶", "10-20": "é‡é™½ç¯€", "12-25": "è–èª•", "12-26": "æ‹†ç¦®ç‰©æ—¥" };
    const holidays2027 = { "1-1": "å…ƒæ—¦", "2-6": "å¹´åˆä¸€", "2-7": "å¹´åˆäºŒ", "2-8": "å¹´åˆä¸‰", "3-26": "è€¶ç©Œå—é›£", "3-27": "å—é›£ç¿Œæ—¥", "3-29": "å¾©æ´»ç¯€", "5-1": "å‹å‹•ç¯€", "5-14": "ä½›èª•", "6-9": "ç«¯åˆç¯€", "7-1": "å›æ­¸", "10-1": "åœ‹æ…¶", "10-8": "é‡é™½ç¯€", "12-25": "è–èª•", "12-27": "æ‹†ç¦®ç‰©è£œå‡" };

    let currentTab = 'dc';
    let dataSets = { 'dc': [], 'cs': [], 'setting': [] };
    let loadedCount = 0;
    
    let today = new Date();
    let calYear = today.getFullYear() < 2026 ? 2026 : today.getFullYear();
    let calMonth = today.getMonth();
    let activeDeliveryDays = [];

    // æ—¥èªŒåŠŸèƒ½
    function log(msg, isError = false) {
        let logBox = document.getElementById('debugLog');
        let color = isError ? '#ff6b6b' : '#0f0';
        logBox.innerHTML += `<div style="color:${color};">[${new Date().toLocaleTimeString()}] ${msg}</div>`;
        logBox.scrollTop = logBox.scrollHeight;
    }

    window.onload = function() {
        let statusPanel = document.getElementById('statusPanel');
        statusPanel.style.display = 'block';
        let statusText = document.getElementById('statusText');
        document.getElementById('testLink').href = rawDC;

        function checkDone() {
            loadedCount++;
            if (loadedCount === 3) {
                statusText.innerText = "âœ… è³‡æ–™è¼‰å…¥å®Œæˆï¼";
                setTimeout(() => { statusPanel.style.display = 'none'; }, 2000);
                renderSettings();
            }
        }

        function handleError(name, err) {
            statusText.innerHTML = `âš ï¸ <b>${name}</b> é€£ç·šå¤±æ•—ã€‚`;
            document.getElementById('debugLog').style.display = 'block';
            document.getElementById('manualTest').style.display = 'block';
            log(`ERROR ${name}: ${JSON.stringify(err)}`, true);
            checkDone();
        }

        Papa.parse(urlDC, { 
            download: true, header: true, skipEmptyLines: true, 
            complete: res => { 
                if(res.data.length === 0) { handleError("DC", "Empty"); return; }
                dataSets['dc'] = res.data; checkDone(); 
            }, 
            error: err => handleError("DC", err) 
        });

        Papa.parse(urlCS, { 
            download: true, header: true, skipEmptyLines: true, 
            complete: res => { dataSets['cs'] = res.data; checkDone(); }, 
            error: err => handleError("CS", err) 
        });

        Papa.parse(urlSetting, { 
            download: true, header: true, skipEmptyLines: true, 
            complete: res => { dataSets['setting'] = res.data; checkDone(); }, 
            error: err => handleError("Setting", err) 
        });
    };

    function renderSettings() {
        let dcHtml = "<ul>", csHtml = "<ul>";
        let hasDC = false, hasCS = false;
        if (dataSets['setting']) {
            dataSets['setting'].forEach(row => {
                let type = row['æ–¹æ¡ˆ'] ? row['æ–¹æ¡ˆ'].trim().toUpperCase() : '';
                let content = row['å…§å®¹'] || '';
                if (content) {
                    if (type === 'DC') { dcHtml += `<li>${content}</li>`; hasDC = true; }
                    if (type === 'CS') { csHtml += `<li>${content}</li>`; hasCS = true; }
                }
            });
        }
        dcHtml += "</ul>"; csHtml += "</ul>";
        if(!hasDC) dcHtml = "<ul><li>(æš«ç„¡é€šå‘Š)</li></ul>";
        if(!hasCS) csHtml = "<ul><li>(æš«ç„¡é€šå‘Š)</li></ul>";
        document.getElementById('content-dc').innerHTML = dcHtml;
        document.getElementById('content-cs').innerHTML = csHtml;
    }

    function switchTab(tab) {
        currentTab = tab;
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active-dc', 'active-cs'));
        let activeBtn = document.querySelector(`.tab-btn[onclick="switchTab('${tab}')"]`);
        if(activeBtn) activeBtn.classList.add(tab === 'dc' ? 'active-dc' : 'active-cs');
        document.getElementById('notice-dc').style.display = (tab === 'dc') ? 'block' : 'none';
        document.getElementById('notice-cs').style.display = (tab === 'cs') ? 'block' : 'none';
        performSearch();
    }

    function performSearch() {
        let input = document.getElementById('searchInput').value.trim();
        let resultContainer = document.getElementById('results');
        let calArea = document.getElementById('calendarArea');
        resultContainer.innerHTML = '';
        activeDeliveryDays = []; 

        if (input.length < 1) {
            resultContainer.innerHTML = '<div class="empty-msg">è«‹è¼¸å…¥åœ°å€é—œéµå­—æŸ¥è©¢</div>';
            calArea.style.display = 'none';
            return;
        }

        let found = false;
        let data = dataSets[currentTab]; 
        if (!data) return;

        data.forEach(row => {
            let region = row['åœ°å€é—œéµå­—'];
            let schedule = row['é€è²¨å®‰æ’'] || '';
            let note = row['âš ï¸ç‰¹åˆ¥å‚™æ³¨'] || row['ç‰¹åˆ¥å‚™æ³¨'] || '';
            let timeSlot = row['æ™‚æ®µ'] || '';

            if (currentTab === 'cs' && !note && timeSlot.length > 30 && !timeSlot.includes("A)")) { note = timeSlot; timeSlot = ""; }

            if (region && region.includes(input)) {
                found = true;
                parseScheduleToDays(schedule);
                let cardClass = "result-card";
                cardClass += (currentTab === 'dc') ? " type-dc" : " type-cs";
                if (schedule && (schedule.includes("ä¸è¨­é€è²¨") || schedule.includes("ä¸é€"))) cardClass += " no-service-card";
                let noteHtml = note ? `<div class="alert-box">âš ï¸ ${note}</div>` : '';
                let timeHtml = timeSlot ? `<div class="info-row"><div class="icon">â°</div><div class="time-slot">${timeSlot}</div></div>` : '';

                let html = `<div class="${cardClass}">
                        <div class="area-header"><div class="area-name">${region}</div><div class="card-tag">${currentTab === 'dc' ? 'DC' : 'CS'} æ–¹æ¡ˆ</div></div>
                        <div class="info-row"><div class="icon">ğŸ“…</div><div>${schedule}</div></div>
                        ${timeHtml} ${noteHtml}
                    </div>`;
                resultContainer.innerHTML += html;
            }
        });

        if (!found) {
            resultContainer.innerHTML = `<div class="empty-msg">æµå””åˆ°ã€Œ${input}ã€å˜…è³‡æ–™ã€‚<br>è©¦ä¸‹åˆ‡æ›ä¸Šæ–¹æŒ‰éˆ•ï¼Ÿ</div>`;
            calArea.style.display = 'none';
        } else {
            calArea.style.display = 'block';
            renderCalendar(); 
        }
    }

    function parseScheduleToDays(text) {
        if (!text) return;
        if (text.includes("ä¸è¨­") || text.includes("ä¸é€")) return;
        let days = new Set(activeDeliveryDays);
        if (text.includes("ç¿Œæ—¥") || text.includes("æ¯æ—¥") || text.includes("ä¸€è‡³æ—¥")) { [0,1,2,3,4,5,6].forEach(d => days.add(d)); }
        else if (text.includes("ä¸€è‡³å…­")) { [1,2,3,4,5,6].forEach(d => days.add(d)); }
        else {
            if (text.includes("ä¸€")) days.add(1); if (text.includes("äºŒ")) days.add(2); if (text.includes("ä¸‰")) days.add(3);
            if (text.includes("å››")) days.add(4); if (text.includes("äº”")) days.add(5); if (text.includes("å…­")) days.add(6);
            if (text.includes("æ—¥")) days.add(0);
        }
        activeDeliveryDays = Array.from(days);
    }

    function changeMonth(delta) {
        calMonth += delta;
        if (calMonth > 11) { calMonth = 0; calYear++; } else if (calMonth < 0) { calMonth = 11; calYear--; }
        renderCalendar();
    }

    function renderCalendar() {
        const grid = document.getElementById('calGrid');
        const title = document.getElementById('calTitle');
        while (grid.children.length > 7) { grid.removeChild(grid.lastChild); }
        title.innerText = `${calYear}å¹´ ${calMonth + 1}æœˆ`;
        
        let firstDayObj = new Date(calYear, calMonth, 1);
        let firstDay = firstDayObj.getDay(); // 0(Sun) - 6(Sat)
        
        // Sun(0) is first, no offset needed if loop starts at 0
        // Offset is simply firstDay because we start at Sun (0)
        let startOffset = firstDay; 

        let daysInMonth = new Date(calYear, calMonth + 1, 0).getDate();
        for (let i = 0; i < startOffset; i++) { let cell = document.createElement('div'); cell.className = 'cal-cell empty'; grid.appendChild(cell); }
        let holidays = (calYear === 2026) ? holidays2026 : (calYear === 2027 ? holidays2027 : {});
        for (let d = 1; d <= daysInMonth; d++) {
            let cell = document.createElement('div'); cell.className = 'cal-cell';
            let currentDayOfWeek = new Date(calYear, calMonth, d).getDay();
            if (activeDeliveryDays.includes(currentDayOfWeek)) { cell.classList.add('highlight'); }
            let dateKey = `${calMonth + 1}-${d}`;
            let holidayName = holidays[dateKey];
            let dateSpan = document.createElement('div'); dateSpan.className = 'cal-date'; dateSpan.innerText = d; cell.appendChild(dateSpan);
            if (holidayName) { cell.classList.add('is-holiday'); let holidaySpan = document.createElement('div'); holidaySpan.className = 'cal-holiday'; holidaySpan.innerText = holidayName; cell.appendChild(holidaySpan); }
            grid.appendChild(cell);
        }
    }
</script>

</body>
</html>